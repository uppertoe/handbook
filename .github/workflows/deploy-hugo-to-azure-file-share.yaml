name: Build and Deploy Hugo to Azure Container App

on:
  push:
    branches:
      - main  # Change to your default branch if different
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  id-token: write

jobs:
  # Build Job
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: "build-azure-webapp"
      cancel-in-progress: true  # Allow canceling in-progress builds
    env:
      HUGO_VERSION: 0.135.0  # Specify your desired Hugo version
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Install Hugo CLI
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Install Dart Sass
        run: sudo snap install dart-sass

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Node.js Dependencies
        run: |
          [[ -f package-lock.json || -f npm-shrinkwrap.json ]] && npm ci || true

      - name: Build with Hugo
        env:
          HUGO_CACHEDIR: ${{ runner.temp }}/hugo_cache
          HUGO_ENVIRONMENT: production
          TZ: America/Los_Angeles
        run: |
          hugo \
            --gc \
            --minify

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy
          path: public/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    concurrency:
      group: "deploy-azure-webapp"
      cancel-in-progress: false  # Prevent canceling in-progress deploys
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy
          path: ./public/
      
      # Login required for container envs
      - name: Authenticate with Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Parse secrets from AZURE_CREDENTIALS and export as environment variables
      - name: Parse secrets from JSON and export environment variables
        run: |
          AZURE_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')
          AZURE_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')
          AZURE_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')

          echo "AZCOPY_SPA_APPLICATION_ID=$AZURE_CLIENT_ID" >> $GITHUB_ENV
          echo "AZCOPY_SPA_CLIENT_SECRET=$AZURE_CLIENT_SECRET" >> $GITHUB_ENV
          echo "AZCOPY_TENANT_ID=$AZURE_TENANT_ID" >> $GITHUB_ENV
          echo "AZCOPY_AUTO_LOGIN_TYPE=SPN" >> $GITHUB_ENV

      - name: Install azcopy
        run: |
          UBUNTU_VERSION=$(lsb_release -rs)
          wget -O packages-microsoft-prod.deb https://packages.microsoft.com/config/ubuntu/${UBUNTU_VERSION}/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y azcopy

      # Upload to temp/ (creating dest folder if necessary)
      - name: Upload new Hugo site content to temp/
        run: |
          azcopy copy "./public/*" "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.file.core.windows.net/${{ secrets.AZURE_FILE_SHARE_NAME }}/temp" --recursive

      # Set container environment to serve from temp/ directory
      - name: Update Azure Container App to Serve from temp/
        run: |
          echo "Updating container environment variable to serve from 'temp/' directory..."
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --set-env-vars "SERVE_DIRECTORY=temp"

      # Remove old files from public/
      - name: Delete Old Files in Azure public/ directory using azcopy
        run: |
          echo "Deleting old files in the Azure public/ directory..."
          azcopy remove "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.file.core.windows.net/${{ secrets.AZURE_FILE_SHARE_NAME }}/public" --recursive

      # Copy between temp/ and public/ (recreating public/)
      - name: Copy new site in temp/ to public/
        run: |
          azcopy copy "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.file.core.windows.net/${{ secrets.AZURE_FILE_SHARE_NAME }}/temp" "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.file.core.windows.net/${{ secrets.AZURE_FILE_SHARE_NAME }}/public" --recursive

      # Set container environment to serve from public/ directory
      - name: Update Azure Container App to Serve from public/
        run: |
          echo "Updating container environment variable to serve from 'public/' directory..."
          az containerapp update \
            --name ${{ secrets.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --set-env-vars "SERVE_DIRECTORY=public"

      # Clean up temp/
      - name: Delete Old Files in Azure temp/ Directory using azcopy
        run: |
          echo "Deleting old files in the Azure temp/ directory..."
          azcopy remove "https://${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}.file.core.windows.net/${{ secrets.AZURE_FILE_SHARE_NAME }}/temp" --recursive

      - name: Cleanup
        run: |
          rm -rf deploy public